@page "/r"
@using Syncfusion.Blazor.RichTextEditor
@using Syncfusion.Blazor.ImageEditor
@using Syncfusion.Blazor.Popups
@inject IJSRuntime jsRuntime

<SfRichTextEditor @ref="EditorRef" @bind-Value="RteValue">
    <RichTextEditorToolbarSettings Items="@Items">
        <RichTextEditorCustomToolbarItems>
            <RichTextEditorCustomToolbarItem Name="ImageEditor">
                <Template>
                    <button class="e-tbar-btn e-btn e-icons edit" id="imageEditor" @onclick="OnImageEditorClick"><span class="e-btn-icon e-icons e-rte-image-editor"></span></button>
                </Template>
            </RichTextEditorCustomToolbarItem>
        </RichTextEditorCustomToolbarItems>
    </RichTextEditorToolbarSettings>
    <RichTextEditorQuickToolbarSettings Image="@ImageQuickTools"></RichTextEditorQuickToolbarSettings>
</SfRichTextEditor>

<input type="file" id="rte-img-upload" style="display:none" accept="image/*" />

<SfDialog @ref="DialogRef" @bind-Visible="@ShowDialog"
          Header="Image Editor" Width="80%" Height="80vh" IsModal="true" ShowCloseIcon="true" ZIndex="10000">
    <DialogEvents Opened="@OnDialogOpened" Closed="@OnDialogClosed" />
    <DialogTemplates>
        <Content>
            @if (IsImageEditorOpen)
            {
                <SfImageEditor @ref="ImageEditorRef" Height="100%" Width="100%" Toolbar="@ImageEditorToolbar">
                    <ImageEditorEvents Created="@OnEditorCreated" />
                </SfImageEditor>
            }
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Insert" IsPrimary="true" OnClick="@OnSaveReplace" />
        <DialogButton Content="Cancel" OnClick="@OnCancel" />
    </DialogButtons>
    <DialogAnimationSettings Effect="DialogEffect.Zoom" />
    <DialogPosition X="center" Y="center" />
</SfDialog>

@code {
    private SfRichTextEditor EditorRef;
    private SfDialog DialogRef;
    private SfImageEditor ImageEditorRef;
    private object DotNetRef;
    private bool ShowDialog = false;
    private bool IsImageEditorOpen = false;
    private string CurrentImageSrc = string.Empty;
    private string RteValue = @"<h2>Rich Text Editor with Image Editing</h2>
    <p>This Rich Text Editor allows you to edit images directly within your content. Select any image and use the Edit Image button to access image editing tools.</p>
    <h4>How to Use</h4>
    <ol>
    <li>Click on an image in the editor to select it</li>
    <li>Click the <strong>Edit Image</strong> button in the main toolbar</li>
    <li>Use the editing tools: crop, zoom, filter, annotate, and fine-tune</li>
    <li>Click <strong>Insert</strong> to replace the original image with your edited version</li>
    </ol>
    <h4>Available Features</h4>
    <ul>
    <li>Crop and resize images</li>
    <li>Apply filters and adjustments</li>
    <li>Rotate and flip images</li>
    <li>Add annotations and drawings</li>
    <li>Support for JPG, PNG, GIF, and WebP formats</li>
    </ul>";

    private List<ImageEditorToolbarItemModel> ImageEditorToolbar = new List<ImageEditorToolbarItemModel>()
    {
        new ImageEditorToolbarItemModel() { Name = "Open" },
        new ImageEditorToolbarItemModel() { Name = "Zoom" },
        new ImageEditorToolbarItemModel() { Name = "Crop" },
        new ImageEditorToolbarItemModel() { Name = "Annotation" },
        new ImageEditorToolbarItemModel() { Name = "Finetune" },
        new ImageEditorToolbarItemModel() { Name = "Filter" },
        new ImageEditorToolbarItemModel() { Name = "Reset" }
    };

    private List<ToolbarItemModel> Items = new List<ToolbarItemModel>()
    {
        new ToolbarItemModel() { Command = ToolbarCommand.Undo },
        new ToolbarItemModel() { Command = ToolbarCommand.Redo },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.Bold },
        new ToolbarItemModel() { Command = ToolbarCommand.Italic },
        new ToolbarItemModel() { Command = ToolbarCommand.Underline },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Command = ToolbarCommand.CreateLink },
        new ToolbarItemModel() { Command = ToolbarCommand.Image },
        new ToolbarItemModel() { Command = ToolbarCommand.Separator },
        new ToolbarItemModel() { Name = "ImageEditor", TooltipText = "Edit Image" },
        new ToolbarItemModel() { Command = ToolbarCommand.SourceCode },
        new ToolbarItemModel() { Command = ToolbarCommand.FullScreen }
    };

    private List<ImageToolbarItemModel> ImageQuickTools = new List<ImageToolbarItemModel>()
    {
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Replace },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Align },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Caption },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Remove },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Separator },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.InsertLink },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Display },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.AltText },
        new ImageToolbarItemModel() { Command = ImageToolbarCommand.Dimension }
    };

    protected override void OnInitialized()
    {
        DotNetRef = DotNetObjectReference.Create<object>(this as object);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await jsRuntime.InvokeAsync<bool>("rteInterop.onInitialized", DotNetRef);
        }
    }

    private async Task OnImageEditorClick()
    {
        if (EditorRef == null) {
            return;
        }
        await EditorRef.SaveSelectionAsync();
        var selectedHtml = await EditorRef.GetSelectedHtmlAsync();
        if (string.IsNullOrWhiteSpace(selectedHtml) || !selectedHtml.Contains("<img", StringComparison.OrdinalIgnoreCase))
        {
            return;
        }
        ExtractImageDetails(selectedHtml);
        ShowDialog = true;
        StateHasChanged();
    }

    private void ExtractImageDetails(string html)
    {
        try
        {
            var srcMatch = System.Text.RegularExpressions.Regex.Match(html, @"src=['""]?([^'""\s>]+)['""]?", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            CurrentImageSrc = srcMatch.Success ? srcMatch.Groups[1].Value : string.Empty;
        }
        catch
        {
            CurrentImageSrc = string.Empty;
        }
    }

    private void OnDialogOpened(Syncfusion.Blazor.Popups.OpenEventArgs args)
    {
        if (!IsImageEditorOpen)
        {
            IsImageEditorOpen = true;
            StateHasChanged();
        }
    }

    private void OnDialogClosed(Syncfusion.Blazor.Popups.CloseEventArgs args)
    {
        IsImageEditorOpen = false;
    }

    private async Task OnEditorCreated()
    {
        if (ImageEditorRef != null && !string.IsNullOrEmpty(CurrentImageSrc))
        {
            await Task.Delay(100);
            await ImageEditorRef.OpenAsync(CurrentImageSrc);
        }
    }

    [JSInvokable]
    public async Task FileSelected(string imageUrl)
    {
        if (ImageEditorRef != null)
        {
            await ImageEditorRef.OpenAsync(imageUrl);
        }
    }

    private async Task OnSaveReplace()
    {
        if (ImageEditorRef == null || EditorRef == null) {
            return;
        }
        
        var imageDataUrl = await ImageEditorRef.GetImageDataUrlAsync();
        if (string.IsNullOrEmpty(imageDataUrl)) {
            return;
        }
        
        string newImageHtml = $@"<img id=""rteImageID"" style=""width: 300px; height: 200px; transform: rotate(0deg); border: 2px solid #ddd;"" alt=""Edited Image"" src=""{imageDataUrl}"" class=""e-rte-image e-imginline"">";
        
        if (!string.IsNullOrEmpty(CurrentImageSrc))
        {
            string escapedOldSrc = System.Text.RegularExpressions.Regex.Escape(CurrentImageSrc);
            RteValue = System.Text.RegularExpressions.Regex.Replace(
                RteValue, 
                @"<img[^>]*src=""?" + escapedOldSrc + @"""?[^>]*>", 
                newImageHtml,
                System.Text.RegularExpressions.RegexOptions.IgnoreCase
            );
        }
        else
        {
            RteValue += newImageHtml;
        }
        
        ShowDialog = false;
        CurrentImageSrc = string.Empty;
        StateHasChanged();
    }

    private Task OnCancel()
    {
        ShowDialog = false;
        return Task.CompletedTask;
    }
}
<style>
    .e-icons.edit::before {
        content: '\e730';
    }
</style>